---

---

<slot />

<script>
  import {
    activeTheme,
    activeShikiTheme,
    THEME_SETTING_KEY,
    SHIKI_SETTING_KEY,
  } from "../../services/stores/settings";

  function updateThemes() {
    const mainTheme = activeTheme.get();
    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition -- window can be undefined, at least while running Vitest.
    globalThis.window?.document.documentElement.setAttribute(
      `data-${THEME_SETTING_KEY}`,
      mainTheme
    );
    document.documentElement.style.colorScheme = mainTheme;

    const codeTheme = activeShikiTheme.get();
    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition -- window can be undefined, at least while running Vitest.
    globalThis.window?.document.documentElement.setAttribute(
      `data-${SHIKI_SETTING_KEY}`,
      codeTheme
    );
  }

  let prefersColorScheme: MediaQueryList | undefined;
  let mainThemeUnsubscribe: () => void | undefined;
  let codeThemeUnsubscribe: () => void | undefined;

  function cleanupThemeListeners() {
    if (prefersColorScheme !== undefined) {
      prefersColorScheme.removeEventListener("change", updateThemes);
    }

    if (mainThemeUnsubscribe !== undefined) {
      mainThemeUnsubscribe();
    }

    if (codeThemeUnsubscribe !== undefined) {
      codeThemeUnsubscribe();
    }
  }

  function setupThemeListeners() {
    // Clean up existing listeners if they exist to prevent edge cases where setup could happen before a previous cleanup completes (e.g. rapid clicks, back/forward navigation).
    cleanupThemeListeners();

    prefersColorScheme = window.matchMedia("(prefers-color-scheme: dark)");
    prefersColorScheme.addEventListener("change", updateThemes);

    mainThemeUnsubscribe = activeTheme.subscribe(updateThemes);
    codeThemeUnsubscribe = activeShikiTheme.subscribe(updateThemes);

    updateThemes();
  }

  setupThemeListeners();
  document.addEventListener("astro:before-swap", cleanupThemeListeners);
  document.addEventListener("astro:after-swap", setupThemeListeners);
</script>
