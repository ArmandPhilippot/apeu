---
import type { ComponentProps } from "astro/types";
import { components } from "../../components/mdx";
import ListingPage from "../../components/organisms/listing-page/listing-page.astro";
import Layout from "../../components/templates/layout/layout.astro";
import { getWebPageGraph } from "../../lib/schema-dts/graphs/webpage-graph";
import { getBreadcrumb } from "../../services/breadcrumb";
import {
  convertToPreview,
  type EnrichedPage,
  type ListableCollectionKey,
} from "../../services/collections";
import { useI18n, type PluralUIKey } from "../../services/i18n";

type Props = Partial<ComponentProps<typeof Layout>> & {
  entry: EnrichedPage<ListableCollectionKey, "preview">;
  pagination?: ComponentProps<typeof ListingPage>["pagination"];
};

const {
  entry: { Content, hasContent, related, ...page },
  pagination,
  ...props
} = Astro.props;
const { locale, translate, translatePlural } = useI18n(page.locale);
const breadcrumb = await getBreadcrumb({ route: Astro.url.pathname });
const graphs: ComponentProps<typeof Layout>["graphs"] = [
  await getWebPageGraph({ ...page, breadcrumb }),
];

const totalTranslationKey = {
  "blog.categories": "meta.value.total.blog.categories",
  "blog.posts": "meta.value.total.blog.posts",
  blogroll: "meta.value.total.blogroll",
  bookmarks: "meta.value.total.bookmarks",
  guides: "meta.value.total.guides",
  notes: "meta.value.total.notes",
  projects: "meta.value.total.projects",
  tags: "meta.value.total.tags",
} satisfies Record<ListableCollectionKey, PluralUIKey>;

const collectionMetaTotal = translatePlural(
  Array.isArray(related.collection)
    ? "meta.value.total.entries"
    : totalTranslationKey[related.collection],
  {
    count: related.total,
  }
);
const entries = await Promise.all(
  related.entries.map(
    async (entry) =>
      await convertToPreview(entry, {
        currentRoute: Astro.url.pathname,
        i18n: { locale, translate, translatePlural },
        showAuthorsIfAvailable: false,
        showCollectionLabel: Array.isArray(related.collection),
      })
  )
);
/* TODO: Ideally, these ids shouldn't be hardcoded here and maybe this should be
 * configurable through the frontmatter instead. So, while waiting for a minor
 * to introduce this, I think this is okay to keep that at the moment. */
const isSmallCardLayout =
  page.collection === "index.pages" &&
  (page.id === `${page.locale}/tags` ||
    page.id === `${page.locale}/blog/categories`);
---

<Layout
  breadcrumb={breadcrumb}
  graphs={graphs}
  pageTitle={page.title}
  seo={page.seo}
  {...props}
>
  <ListingPage
    cover={page.cover}
    entries={entries}
    pagination={pagination}
    route={page.route}
    sizeMinCols={isSmallCardLayout ? "22em" : "30em"}
    title={page.title}
    totalEntries={collectionMetaTotal}
  >
    {
      hasContent && (
        <Content components={components} slot={hasContent ? "intro" : ""} />
      )
    }
  </ListingPage>
</Layout>
