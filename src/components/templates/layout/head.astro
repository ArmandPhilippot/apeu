---
import { getImage, Font } from "astro:assets";
import { ClientRouter } from "astro:transitions";
import type { Graph } from "schema-dts";
import faviconPng from "../../../assets/favicon.png";
import faviconSvg from "../../../assets/logo-unpressed.svg";
import { getJsonLdSchema } from "../../../lib/schema-dts/schema";
import { getCollectionsFeeds } from "../../../services/feeds";
import { getLanguageTerritory, useI18n } from "../../../services/i18n";
import type { SEO } from "../../../types/data";
import { WEBSITE_URL } from "../../../utils/constants";
import { removeTrailingSlashes } from "../../../utils/strings";
import { isDefaultLocale } from "../../../utils/type-guards";

type ColorScheme =
  | "normal"
  | "light"
  | "dark"
  | "only light"
  | "light dark"
  | "dark light";

type OpenGraphType =
  | "article"
  | "book"
  | "music.album"
  | "music.playlist"
  | "music.radio_station"
  | "music.song"
  | "profile"
  | "video.episode"
  | "video.movie"
  | "video.other"
  | "video.tv_show"
  | "website";

type Props = {
  brand: string;
  colorScheme?: ColorScheme | null | undefined;
  graphs?: Graph["@graph"] | null | undefined;
  isHome: boolean;
  seo: SEO;
  themeColor?: string | null | undefined;
  title: string;
};

const { brand, colorScheme, graphs, isHome, seo, themeColor, title } =
  Astro.props;
const { locale, translate } = useI18n(Astro.currentLocale);
const appleTouchIcon = await getImage({
  src: faviconPng,
  width: 180,
  height: 180,
  format: "png",
});
const icon = await getImage({ src: faviconSvg, format: "svg" });
const feeds = await getCollectionsFeeds(locale);
const addBrandToTitle = !isHome;
const ogType: OpenGraphType = isHome ? "website" : "article";
const localeTerritory = locale.includes("_")
  ? locale
  : getLanguageTerritory(locale);
const altLocales = seo.languages?.map((altLocale) =>
  getLanguageTerritory(altLocale.locale)
);
const ogHomeImgPath = isDefaultLocale(locale) ? "home" : `${locale}/home`;
const ogImgPath = isHome ? ogHomeImgPath : Astro.url.pathname.slice(1);
const socialImg = {
  height: 630,
  type: "image/png",
  url: new URL(`/og/${removeTrailingSlashes(ogImgPath)}.png`, WEBSITE_URL).href,
  width: 1200,
} as const;

/* eslint-disable-next-line @eslint-community/eslint-comments/disable-enable-pair -- No need to pollute the template with an enable pair. */
/* eslint-disable astro/sort-attributes -- Sorting is fine for custom components, but I think meta are easier to read with name first. */
---

<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>{`${seo.title}${addBrandToTitle ? ` | ${brand}` : ""}`}</title>
  <slot name="blocking" />
  <Font cssVariable="--font-inter" preload />
  <Font cssVariable="--font-cousine" preload />
  <ClientRouter fallback="swap" />
  <meta name="description" content={seo.description ?? ""} />
  <meta
    name="robots"
    content={[
      seo.noindex ? "noindex" : "index",
      seo.nofollow ? "nofollow" : "follow",
    ].join(", ")}
  />
  <link rel="canonical" href={seo.canonical ?? Astro.url.href} />
  {
    Astro.site && seo.languages
      ? seo.languages.map((language) => (
          <link
            rel="alternate"
            href={new URL(language.route, Astro.site)}
            hreflang={language.locale}
          />
        ))
      : null
  }
  {
    seo.author ? (
      <>
        <meta name="author" content={seo.author.name} />
        <link rel="author" href={seo.author.website} />
      </>
    ) : (
      <>
        <meta name="author" content={brand} />
        {Astro.site ? <link rel="author" href={Astro.site.href} /> : null}
      </>
    )
  }
  {colorScheme ? <meta name="color-scheme" content={colorScheme} /> : null}
  {themeColor ? <meta name="theme-color" content={themeColor} /> : null}
  <meta content={title} property="og:title" />
  <meta content={ogType} property="og:type" />
  <meta content={socialImg.url} property="og:image" />
  <meta content={socialImg.type} property="og:image:type" />
  <meta content={`${socialImg.width}`} property="og:image:width" />
  <meta content={`${socialImg.height}`} property="og:image:height" />
  <meta content={Astro.url} property="og:url" />
  {
    seo.description ? (
      <meta content={seo.description} property="og:description" />
    ) : null
  }
  <meta content={localeTerritory} property="og:locale" />
  {
    altLocales?.map((lang) => (
      <meta content={lang} property="og:locale:alternate" />
    ))
  }
  <meta content={brand} property="og:site_name" />
  <slot name="open-graph" />
  <meta content="summary_large_image" name="twitter:card" />
  <meta content={socialImg.url} name="twitter:image" />
  <meta content={title} name="twitter:title" />
  {
    seo.description ? (
      <meta content={seo.description} name="twitter:description" />
    ) : null
  }
  <link rel="icon" href="/favicon.ico" sizes="32x32" />
  <link rel="icon" href={icon.src} type="image/svg+xml" />
  <link rel="apple-touch-icon" href={appleTouchIcon.src} />
  <link rel="manifest" href="/manifest.json" />
  <link rel="sitemap" href="/sitemap-index.xml" />
  {
    Astro.site ? (
      <Fragment>
        <link
          rel="alternate"
          href={new URL("./feed.xml", Astro.site)}
          title={translate("feed.website.link.title")}
          type="application/rss+xml"
        />
        {feeds.map((feed) => (
          <link
            rel="alternate"
            href={new URL(feed.path, Astro.site)}
            title={feed.label}
            type="application/rss+xml"
          />
        ))}
      </Fragment>
    ) : null
  }
  {
    graphs ? (
      <script
        type="application/ld+json"
        is:inline
        set:html={JSON.stringify(getJsonLdSchema(graphs))}
      />
    ) : null
  }
  <slot />
</head>
